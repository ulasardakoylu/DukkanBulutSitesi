@inject IPermissionService Perms

@{
    var canQuick = await Perms.HasAsync(User, "personnel.quick_work_panel");
    var canStock = await Perms.HasAsync(User, "personnel.stock_control");
    var canSecurityPanel = await Perms.HasAsync(User, "personnel.security_work_panel");
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
<link rel="stylesheet" href="~/css/manager.css" />

<script>
    // Block Shift+Enter everywhere EXCEPT textarea
    (function () {
        document.addEventListener('keydown', function (e) {
            if (e.key !== 'Enter' || !e.shiftKey) return;

            const el = e.target;
            if (!el) return;

            // allow Shift+Enter inside textarea (newline)
            if (el.tagName === 'TEXTAREA') return;

            // also allow any contenteditable (if you ever add rich text later)
            if (el.isContentEditable) return;

            e.preventDefault();
            e.stopPropagation();
        }, true); // <-- capture mode is important
    })();
</script>

@{
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString();
}

<body class="manager-body">
    <div class="manager-wrapper">
        <!-- LEFT SIDEBAR -->
        <aside class="manager-sidebar">
            <div class="mgr-sidebar-header d-flex align-items-center mb-3">
                <button class="btn btn-link mgr-back-btn p-0 me-2"
                        type="button"
                        onclick="window.location.href='@Url.Action("Index", "Home")'">
                    <i class="bi bi-arrow-left-circle fs-4"></i>
                </button>

                <div>
                    <div class="mgr-sidebar-title">PERSONEL PANELİ</div>
                    <div class="small text-light opacity-75">
                        @User.Identity?.Name
                    </div>
                </div>
            </div>

            <!-- NAV -->
            <nav class="manager-nav mb-3">
                <a asp-controller="Personnel"
                   asp-action="Dashboard"
                   class="mgr-nav-link @(ViewContext.RouteData.Values["action"]?.ToString() == "Dashboard" ? "active" : "")">
                    Gösterge Paneli
                </a>

                <a asp-controller="Personnel"
                   asp-action="Conversations"
                   class="mgr-nav-link @(ViewContext.RouteData.Values["action"]?.ToString() == "Conversations" ? "active" : "")">
                    Konuşmalar
                </a>

                @if (canQuick)
                {
                    <a asp-controller="Personnel"
                    asp-action="QuickWorkPanel"
                    class="mgr-nav-link @(ViewContext.RouteData.Values["action"]?.ToString() == "QuickWorkPanel" ? "active" : "")">
                        Hızlı İş Paneli
                    </a>
                }

                @if (canStock)
                {
                    <a asp-controller="Personnel"
                    asp-action="StockControl"
                    class="mgr-nav-link @(ViewContext.RouteData.Values["action"]?.ToString() == "StockControl" ? "active" : "")">
                        Stok Kontrol
                    </a>
                }

                @if (canSecurityPanel)
                {
                    <a asp-controller="Personnel"
                       asp-action="SecurityWorkPanel"
                       class="mgr-nav-link @(ViewContext.RouteData.Values["action"]?.ToString() == "SecurityWorkPanel" ? "active" : "")">
                        Güvenlik İş Paneli
                    </a>
                }

                <a asp-controller="Personnel"
                   asp-action="About"
                   class="mgr-nav-link @(ViewContext.RouteData.Values["action"]?.ToString() == "About" ? "active" : "")">
                    Hakkında
                </a>

            </nav>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <div class="personnel-main">
            @if (!string.Equals(currentAction, "Dashboard", StringComparison.OrdinalIgnoreCase))
            {
                <header class="personnel-header d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Personel Paneli</h2>

                    <div class="d-flex align-items-center gap-3">
                        <a asp-controller="Personnel" asp-action="Conversations"
                           class="btn btn-link text-light p-0 personnel-header-chat" title="Konuşmalar">
                            <i class="bi bi-chat-dots fs-4"></i>
                        </a>

                        <div class="text-light small personnel-header-clock"
                             id="layoutClock"
                             data-server-now="@DateTime.UtcNow.ToString("o")">
                            @DateTime.Now.ToString("dd.MM.yyyy HH:mm")
                        </div>

                    </div>
                </header>
            }

            <div class="personnel-main-inner">
                @RenderBody()
            </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            (function () {
                const el = document.getElementById('layoutClock');
                if (!el) return;

                // server time captured at render time (UTC)
                const serverIso = el.getAttribute('data-server-now');
                if (!serverIso) return;

                const serverAtRenderMs = Date.parse(serverIso);      // UTC ms
                const clientAtRenderMs = Date.now();                 // client ms at same moment
                const offsetMs = serverAtRenderMs - clientAtRenderMs; // server = client + offset

                function pad2(n) { return n < 10 ? '0' + n : '' + n; }

                function tick() {
                    const serverNow = new Date(Date.now() + offsetMs);

                    // Display format: dd.MM.yyyy HH:mm
                    const dd = pad2(serverNow.getDate());
                    const mm = pad2(serverNow.getMonth() + 1);
                    const yyyy = serverNow.getFullYear();
                    const HH = pad2(serverNow.getHours());
                    const MM = pad2(serverNow.getMinutes());

                    el.textContent = `${dd}.${mm}.${yyyy} ${HH}:${MM}`;
                }

                tick();

                // Align interval to the next second boundary for smoother ticking
                const delay = 1000 - (Date.now() % 1000);
                setTimeout(() => {
                    tick();
                    setInterval(tick, 1000);
                }, delay);
            })();
        </script>


    @RenderSection("Scripts", required: false)
</body>