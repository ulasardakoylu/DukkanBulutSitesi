@model IEnumerable<Entity.Store>

@{
    ViewData["Title"] = "Hoşgeldiniz";
    Layout = "_StorefrontLayout";


}

<link rel="stylesheet" href="~/css/store.css" />

<style>
    .floating-tooltip-wrapper {
        position: fixed;
        bottom: 25px;
        right: 25px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        z-index: 5000;
        transition: transform 0.15s ease;
    }

        .floating-tooltip-wrapper:hover {
            transform: scale(1.08);
        }

    .floating-tooltip-icon {
        width: 70%;
        height: 70%;
        object-fit: contain;
    }
</style>

<!-- TOP NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="@Url.Action("Welcome", "Home")">
            DükkanBulut
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#welcomeNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="welcomeNavbar">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" href="@Url.Action("Welcome", "Home")">Ana Sayfa</a>
                </li>
            </ul>

            <div class="d-flex">
                @if (User.Identity?.IsAuthenticated ?? false)
                {
                    <span class="navbar-text me-3">
                        Hoşgeldiniz, @User.Identity!.Name
                    </span>

                    @if (User.IsInRole("Owner"))
                    {
                        <a class="btn btn-outline-primary btn-sm me-2"
                           href="@Url.Action("Dashboard", "Owner")">
                            Sahip Paneli
                        </a>
                    }
                    else if (User.IsInRole("Manager"))
                    {
                        <a class="btn btn-outline-primary btn-sm me-2"
                           href="@Url.Action("Dashboard", "Manager")">
                            Yönetici Paneli
                        </a>
                    }
                    else if (User.HasClaim("IsPersonnel", "true") || User.IsInRole("Personnel"))
                    {
                        <a class="btn btn-outline-primary btn-sm me-2"
                           href="@Url.Action("Dashboard", "Personnel")">
                            Personel Paneli
                        </a>
                    }



                    <form method="post" asp-controller="Auth" asp-action="Logout" class="d-inline">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-secondary btn-sm">Çıkış Yap</button>
                    </form>
                }
                else
                {
                    <button class="btn btn-primary btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#loginModal">
                        Giriş Yap
                    </button>
                }
            </div>
        </div>
    </div>
</nav>

<div class="container">

    <!-- Intro -->
    <section class="mb-4">
        <h1 class="mb-3">DükkanBulut Sistemine Hoşgeldiniz</h1>
        <p class="text-muted">
            Aşağıdan ziyaret etmek istediğiniz mağazayı seçin veya giriş yaparak hesabınızın olduğu veya yetkili olduğunuz mağazaya
            otomatik yönlendirilmeyi sağlayın.
        </p>
    </section>

    <!-- Store cards -->
    <section>
        <h4 class="mb-3">Dükkanlar</h4>

        @if (Model != null && Model.Any())
        {
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                @foreach (var s in Model)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">@s.StoreName</h5>

                                @if (!string.IsNullOrWhiteSpace(s.StoreDescription))
                                {
                                    <p class="card-text text-muted">@s.StoreDescription</p>
                                }
                                else
                                {
                                    <p class="card-text text-muted">
                                        Bu mağaza hakkında detaylı açıklama eklenmemiştir.
                                    </p>
                                }

                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        Adres: @s.StoreAddress
                                    </small>

                                    <!-- Selecting store: go to ürünler with ?storeId= -->
                                    <a class="btn btn-primary btn-sm"
                                       href="@Url.Action("Index", "Home", new { storeId = s.StoreID })">
                                        Dükkana Git
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-info mt-3">
                Henüz tanımlı bir mağaza bulunmuyor. Lütfen daha sonra tekrar deneyin.
            </div>
        }
    </section>

    <section class="mt-4">
        <hr />
        <p class="text-muted">
            Eğer mağaza sahibi veya personelseniz, yukarıdaki <strong>Giriş Yap</strong> butonunu kullanarak sisteme giriş yapabilirsiniz. Giriş yaptıktan sonra yetkinize göre ilgili panele
            yönlendirileceksiniz.
        </p>
    </section>
</div>

<!-- LOGIN MODAL -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Giriş Yap</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                @if (TempData["OpenModal"]?.ToString() == "login" &&
                                TempData["AuthError"] is string le &&
                                !string.IsNullOrEmpty(le))
                {
                    <div class="alert alert-danger">@Html.Raw(le)</div>
                }

                <form method="post" asp-controller="Auth" asp-action="Login">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="ReturnUrl" value="@Url.Action("Welcome", "Home")" />

                    <div class="mb-3">
                        <label class="form-label">E-Mail Adresi</label>
                        <input type="email" name="Email" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Şifre</label>
                        <input type="password" name="Password" class="form-control" required />
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Giriş Yap</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- TOOLTIP -->
<div class="floating-tooltip-wrapper wide-tooltip"
     data-bs-toggle="tooltip"
     data-bs-placement="left"
     data-bs-html="true"
     data-bs-title="Bu sistem <strong>Ulaş Arda Köylü</strong> ve <strong>İlhan Egemen Durmuş</strong> tarafından <strong>İnternet Programcılığı 2</strong> dersi için yapılmıştır.">
    <img src="/img/tooltip.png" class="floating-tooltip-icon" alt="Tooltip" />
</div>



@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const tooltipTriggerList = [].slice.call(
                document.querySelectorAll('[data-bs-toggle="tooltip"]')
            );

            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            const open = "@(TempData["OpenModal"] ?? "")";
            if (open === "login") new bootstrap.Modal('#loginModal').show();
        });
    </script>

    <script>
        (function () {

            const handledTypes = new Set([
                'text',
                'password',
                'number',
                'email',
                'search',
                'tel',
                'url'
            ]);

            document.addEventListener('keydown', function (e) {
                if (e.key !== 'Enter') return;

                const el = e.target;

                // Only INPUTs inside a form
                if (!el || el.tagName !== 'INPUT') return;
                if (!el.form) return;

                if (el.readOnly || el.disabled) return;

                if (el.type === 'file') return;

                const type = (el.type || '').toLowerCase();
                if (!handledTypes.has(type)) return;

                if (e.shiftKey) {
                    e.preventDefault();
                    return;
                }

                e.preventDefault();
                el.form.submit();
            });

        })();
    </script>
}
